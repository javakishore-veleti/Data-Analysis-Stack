name: 03 Docker Promote Tag to Latest

on:
  workflow_dispatch:
    inputs:
      source_tag:
        description: "Existing Docker image tag to promote (e.g. 2026-02-07-18-42-11)"
        required: true

permissions:
  contents: write   # Required to create/push Git tags

jobs:
  promote:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # Checkout repo (needed for Git tagging)
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------------------------------
      # Set variables
      # -------------------------------------------------
      - name: Set image and tag variables
        run: |
          echo "IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/data-analysis-stack" >> $GITHUB_ENV
          echo "SOURCE_TAG=${{ github.event.inputs.source_tag }}" >> $GITHUB_ENV

      # -------------------------------------------------
      # Configure Git identity
      # -------------------------------------------------
      - name: Configure Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # -------------------------------------------------
      # Check if Git tag already exists
      # -------------------------------------------------
      - name: Check if Git tag exists
        id: check_tag
        run: |
          if git rev-parse "${SOURCE_TAG}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      # -------------------------------------------------
      # Create Git tag ONLY if missing
      # -------------------------------------------------
      - name: Create Git tag (if missing)
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          git tag -a "${SOURCE_TAG}" \
            -m "Docker image promoted to latest: ${IMAGE}:${SOURCE_TAG}"

          git push origin "${SOURCE_TAG}"

      # -------------------------------------------------
      # Login to Docker Hub
      # -------------------------------------------------
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # -------------------------------------------------
      # Pull existing image
      # -------------------------------------------------
      - name: Pull existing image
        run: |
          docker pull $IMAGE:$SOURCE_TAG

      # -------------------------------------------------
      # Promote to latest
      # -------------------------------------------------
      - name: Promote image to latest
        run: |
          docker tag $IMAGE:$SOURCE_TAG $IMAGE:latest
          docker push $IMAGE:latest
